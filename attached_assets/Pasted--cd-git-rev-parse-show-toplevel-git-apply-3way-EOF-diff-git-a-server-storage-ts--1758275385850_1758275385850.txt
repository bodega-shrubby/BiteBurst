 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/server/storage.ts b/server/storage.ts
index 408db5219fe772602e538ff17e84b7ea1633fa06..253b937d2c0c5743ceb7a25200310e6a1f3e6351 100644
--- a/server/storage.ts
+++ b/server/storage.ts
@@ -1,79 +1,86 @@
 import {
   users,
   logs,
   streaks,
   badges,
   xpEvents,
   avatars,
   goals,
   lessonAttempts,
+  lessons,
+  lessonSteps,
   type User,
   type InsertUser,
   type Log,
   type InsertLog,
   type Streak,
   type Badge,
   type Avatar,
   type Goal,
   type LessonAttempt,
   type InsertLessonAttempt,
+  type Lesson,
+  type LessonStep,
 } from "@shared/schema";
 import { db } from "./db";
-import { eq, and, desc } from "drizzle-orm";
+import { eq, desc, asc } from "drizzle-orm";
 
 // Interface for storage operations
 export interface IStorage {
   // User operations
   getUser(id: string): Promise<User | undefined>;
   getUserByEmail(email: string): Promise<User | undefined>;
   getUserByDisplayName(displayName: string): Promise<User | undefined>;
   createUser(insertUser: Partial<InsertUser>): Promise<User>;
   updateUser(id: string, updates: Partial<InsertUser>): Promise<User>;
   
   // Avatar and Goal operations
   getAvatars(): Promise<Avatar[]>;
   getGoals(): Promise<Goal[]>;
   
   // Log operations
   createLog(insertLog: Partial<InsertLog>): Promise<Log>;
   getUserLogs(userId: string, limit?: number): Promise<Log[]>;
   
   // Streak operations
   getUserStreak(userId: string): Promise<Streak | undefined>;
   updateStreak(userId: string, updates: Partial<{ current: number; longest: number; lastActive: Date }>): Promise<Streak>;
   
   // Badge operations
   getUserBadges(userId: string): Promise<Badge[]>;
   awardBadge(userId: string, badgeId: string): Promise<Badge>;
   
   // XP operations
   updateUserXP(userId: string, updates: { totalXp: number; level: number; streak: number; lastLogAt: Date }): Promise<User>;
   logXPEvent(event: { userId: string; amount: number; reason: string; refLog?: string }): Promise<any>;
-  
+
   // Lesson attempt operations
   logLessonAttempt(insertAttempt: InsertLessonAttempt): Promise<LessonAttempt>;
+
+  // Lesson data
+  getLessonWithSteps(lessonId: string): Promise<(Lesson & { steps: LessonStep[] }) | null>;
 }
 
 export class DatabaseStorage implements IStorage {
   async getUser(id: string): Promise<User | undefined> {
     const [user] = await db.select().from(users).where(eq(users.id, id));
     return user || undefined;
   }
 
   async getUserByEmail(email: string): Promise<User | undefined> {
     const [user] = await db.select().from(users).where(eq(users.email, email));
     return user || undefined;
   }
 
   // Add method for finding user by display name (used as username)
   async getUserByDisplayName(displayName: string): Promise<User | undefined> {
     const [user] = await db.select().from(users).where(eq(users.displayName, displayName));
     return user || undefined;
   }
 
   async createUser(insertUser: Partial<InsertUser>): Promise<User> {
     const [user] = await db
       .insert(users)
       .values(insertUser as any)
       .returning();
     return user;
diff --git a/server/storage.ts b/server/storage.ts
index 408db5219fe772602e538ff17e84b7ea1633fa06..253b937d2c0c5743ceb7a25200310e6a1f3e6351 100644
--- a/server/storage.ts
+++ b/server/storage.ts
@@ -170,29 +177,44 @@ export class DatabaseStorage implements IStorage {
       .where(eq(users.id, userId))
       .returning();
     return user;
   }
 
   async logXPEvent(event: { userId: string; amount: number; reason: string; refLog?: string }): Promise<any> {
     const [xpEvent] = await db
       .insert(xpEvents)
       .values({
         userId: event.userId,
         amount: event.amount,
         reason: event.reason,
         refLog: event.refLog,
       })
       .returning();
     return xpEvent;
   }
 
   async logLessonAttempt(insertAttempt: InsertLessonAttempt): Promise<LessonAttempt> {
     const [attempt] = await db
       .insert(lessonAttempts)
       .values(insertAttempt as any)
       .returning();
     return attempt;
   }
+
+  async getLessonWithSteps(lessonId: string): Promise<(Lesson & { steps: LessonStep[] }) | null> {
+    const [lesson] = await db.select().from(lessons).where(eq(lessons.id, lessonId));
+    if (!lesson) {
+      return null;
+    }
+
+    const steps = await db
+      .select()
+      .from(lessonSteps)
+      .where(eq(lessonSteps.lessonId, lessonId))
+      .orderBy(asc(lessonSteps.stepNumber));
+
+    return { ...lesson, steps };
+  }
 }
 
 // Use PostgreSQL as primary database
 export const storage = new DatabaseStorage();
 
EOF
)