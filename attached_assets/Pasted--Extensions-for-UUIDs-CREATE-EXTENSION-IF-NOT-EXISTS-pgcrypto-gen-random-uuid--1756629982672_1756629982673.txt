-- ==== Extensions (for UUIDs) ====
CREATE EXTENSION IF NOT EXISTS pgcrypto;   -- gen_random_uuid()

-- ==== Enums ====
CREATE TYPE age_bracket  AS ENUM ('6-8','9-11','12-14');
CREATE TYPE goal_enum    AS ENUM ('energy','focus','strength');
CREATE TYPE log_type     AS ENUM ('food','activity');
CREATE TYPE entry_method AS ENUM ('emoji','text','photo');

-- ==== Timestamp trigger ====
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql;

-- ==== Catalogs (optional but useful) ====
CREATE TABLE IF NOT EXISTS avatars (
  id    TEXT PRIMARY KEY,          -- e.g. 'mascot-01'
  label TEXT NOT NULL,
  src   TEXT NOT NULL              -- asset path/url
);

CREATE TABLE IF NOT EXISTS goals (
  id    goal_enum PRIMARY KEY,
  label TEXT NOT NULL
);

-- ==== Users ====
CREATE TABLE IF NOT EXISTS users (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  display_name   TEXT NOT NULL CHECK (length(display_name) BETWEEN 2 AND 20),
  age_bracket    age_bracket NOT NULL,
  goal           goal_enum NOT NULL REFERENCES goals(id),
  email          CITEXT UNIQUE,                -- optional
  parent_consent BOOLEAN NOT NULL DEFAULT FALSE,
  avatar_id      TEXT REFERENCES avatars(id),
  locale         TEXT DEFAULT 'en-GB',
  tz             TEXT,
  xp             INT  NOT NULL DEFAULT 0,
  streak         INT  NOT NULL DEFAULT 0,
  status         TEXT NOT NULL DEFAULT 'active',
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TRIGGER users_set_updated_at
BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION set_updated_at();
CREATE INDEX IF NOT EXISTS idx_users_email ON users (email);

-- ==== Logs (food & activity) ====
CREATE TABLE IF NOT EXISTS logs (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  log_date      DATE NOT NULL DEFAULT CURRENT_DATE,
  ts            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  type          log_type NOT NULL,
  entry_method  entry_method NOT NULL,
  content       JSONB,                 -- emoji/text/photoB64 metadata
  goal_context  goal_enum,             -- snapshot at log time
  ai_feedback   TEXT,
  xp_awarded    INT NOT NULL DEFAULT 0
);
CREATE INDEX IF NOT EXISTS idx_logs_user_date ON logs (user_id, log_date DESC);
CREATE INDEX IF NOT EXISTS idx_logs_content_gin ON logs USING GIN (content);

-- ==== Streaks (fast reads) ====
CREATE TABLE IF NOT EXISTS streaks (
  user_id     UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  current     INT NOT NULL DEFAULT 0,
  longest     INT NOT NULL DEFAULT 0,
  last_active DATE,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TRIGGER streaks_set_updated_at
BEFORE UPDATE ON streaks FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ==== Badges ====
CREATE TABLE IF NOT EXISTS badges (
  user_id    UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  badge_id   TEXT NOT NULL,                   -- e.g. 'first-log','streak-7'
  awarded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  PRIMARY KEY (user_id, badge_id)
);
CREATE INDEX IF NOT EXISTS idx_badges_user ON badges (user_id);

-- ==== XP Ledger (audit XP changes) ====
CREATE TABLE IF NOT EXISTS xp_events (
  id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id   UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  amount    INT NOT NULL,                      -- +/- XP
  reason    TEXT,                              -- 'log:food','streak-bonus'
  ref_log   UUID REFERENCES logs(id),          -- optional link to a log
  ts        TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_xp_user_ts ON xp_events (user_id, ts DESC);

-- ==== Minimal seeds (safe to re-run) ====
INSERT INTO avatars (id,label,src) VALUES
  ('mascot-01','Zestie','/assets/mascot-biteburst@512.png')
ON CONFLICT DO NOTHING;

INSERT INTO goals (id,label) VALUES
  ('energy','Energy âš¡'),
  ('focus','Focus ðŸ§ '),
  ('strength','Strength ðŸ’ª')
ON CONFLICT DO NOTHING;
